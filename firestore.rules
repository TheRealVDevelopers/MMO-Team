rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: check if the caller has a staffUsers document (i.e. is staff, not a client-only user)
    function isStaff() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staffUsers/$(request.auth.uid));
    }

    // Helper: check if the caller is a client (has a clients document)
    function isClient() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/clients/$(request.auth.uid));
    }

    // Helper function to get staff role safely
    function getStaffRole() {
      return get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isStaff() && 
        (getStaffRole() == 'Super Admin' || getStaffRole() == 'Admin');
    }

    // ========================================
    // B2I CLIENTS
    // ========================================
    match /b2iClients/{b2iId} {
      // Super Admin: all access
      // B2I Parent (staff or client login): read own B2I doc
      allow read: if isStaff() && getStaffRole() == 'Super Admin';
      allow read: if isStaff() &&
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.b2iId == b2iId;
      allow read: if isClient() &&
        get(/databases/$(database)/documents/clients/$(request.auth.uid)).data.b2iId == b2iId;
      allow write: if isStaff() && getStaffRole() == 'Super Admin';
    }

    // ========================================
    // CLIENTS (client portal users)
    // ========================================
    match /clients/{clientId} {
      // Clients can read/write their own doc
      allow read, write: if isAuthenticated() && request.auth.uid == clientId;
      // Staff can read all client docs
      allow read: if isStaff();
    }

    // ========================================
    // ORGANIZATIONS
    // ========================================
    match /organizations/{orgId} {
      // All authenticated users (staff + clients) can read orgs
      allow read: if isAuthenticated();
      // Staff (except B2I Client role) can write
      allow write: if isStaff() && getStaffRole() != 'B2I Client';

      // Subcollections under organizations (ledger, invoices, inventory, validation requests, etc.)
      match /{subcollection=**} {
        allow read: if isAuthenticated();
        allow write: if isStaff();
      }
    }

    // ========================================
    // VENDORS
    // ========================================
    match /vendors/{vendorId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isStaff();
    }

    // ========================================
    // ERROR REPORTS
    // ========================================
    match /errorReports/{reportId} {
      allow read, write: if isStaff();
    }

    // ========================================
    // CASES (Central Source of Truth)
    // ========================================
    match /cases/{caseId} {
       // Helper: Check if user is the assigned client (via email match)
       function isCaseClient() {
         return request.auth.token.email == resource.data.clientEmail;
       }
       
       // Staff: Read/Write all
       allow read, write: if isStaff();
         
       // Client: Read own case (matched by email)
       allow read: if isAuthenticated() && isCaseClient();
       
       // Client: Read own case (matched by clientUid field)
       allow read: if isAuthenticated() && resource.data.clientUid == request.auth.uid;
       
       // Client: Restricted Update (Chat, Approvals & Lead Journey Reviews only)
       allow update: if isAuthenticated() && (isCaseClient() || resource.data.clientUid == request.auth.uid) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['chat', 'approvals', 'leadJourney', 'updatedAt']);

      // Subcollections under cases (tasks, documents, activities, payments, approvals, quotations, etc.)
      match /{subcollection=**} {
        // Staff: full access
        allow read, write: if isStaff();
        
        // Client: read subcollections of their own case
        // (We can't easily re-check the parent doc here, so allow read for any authenticated client)
        allow read: if isClient();
        
        // Client: write to specific subcollections (payments, approvals, jms)
        allow write: if isClient();
      }
    }

    // ========================================
    // STAFF USERS (staff login: Auth â†’ staffUsers/{uid})
    // ========================================
    match /staffUsers/{uid} {
      // Staff can read their own doc
      allow read: if isAuthenticated() && request.auth.uid == uid;
      // Any authenticated user can read staff docs (needed for displaying names, etc.)
      allow read: if isStaff();
      // Staff can write (admin operations)
      allow write: if isStaff();
    }

    // ========================================
    // CATALOG
    // ========================================
    match /catalog/{docId} {
      allow read: if isAuthenticated();
      allow write: if isStaff();
      
      match /{subcollection=**} {
        allow read: if isAuthenticated();
        allow write: if isStaff();
      }
    }

    // ========================================
    // CHAT
    // ========================================
    match /chat_channels/{channelId} {
      allow read, write: if isAuthenticated();
    }
    match /chat_messages/{messageId} {
      allow read, write: if isAuthenticated();
    }

    // ========================================
    // TIME ENTRIES
    // ========================================
    match /timeEntries/{entryId} {
      allow read: if isAuthenticated();
      allow write: if isStaff();
    }

    // ========================================
    // SYSTEM CONFIG
    // ========================================
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // APPROVAL REQUESTS (legacy top-level collection)
    // ========================================
    match /approvalRequests/{requestId} {
      allow read: if isAuthenticated();
      allow write: if isStaff();
    }

    // ========================================
    // NOTIFICATIONS (under staffUsers)
    // ========================================
    match /staffUsers/{uid}/notifications/{notifId} {
      allow read: if isAuthenticated() && request.auth.uid == uid;
      allow write: if isStaff();
    }

    // ========================================
    // BASELINE: Catch-all for any other collections
    // ========================================
    match /{document=**} {
      // Staff: read/write access (except B2I Client who is read-only)
      allow read: if isStaff();
      allow write: if isStaff() && getStaffRole() != 'B2I Client';
      
      // Clients: read-only access to remaining collections
      allow read: if isClient();
    }
  }
}
