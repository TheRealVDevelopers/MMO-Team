rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data;
    }
    
    function isStaffUser() {
      return isAuthenticated() && exists(/databases/$(database)/documents/staffUsers/$(request.auth.uid));
    }
    
    function isAdmin() {
      return isStaffUser() && getUserData().role in ['Super Admin', 'Admin', 'Sales General Manager'];
    }
    
    // ========================================
    // ORGANIZATIONS
    // ========================================
    
    match /organizations/{orgId} {
      allow read: if isStaffUser();
      allow write: if isAdmin();
    }
    
    // ========================================
    // STAFF USERS
    // ========================================
    
    match /staffUsers/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || 
        getUserData().role in ['Super Admin', 'Admin']
      );
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated();
      }
    }
    
    // ========================================
    // CASES (ROOT LEVEL - SACRED BOUNDARY)
    // Every query MUST filter by organizationId
    // Staff users are GLOBAL and can access cases across organizations
    // ========================================
    
    match /cases/{caseId} {
      allow read: if isStaffUser();
      allow create: if isStaffUser() && request.resource.data.organizationId != null;
      allow update: if isStaffUser();
      allow delete: if isAdmin();
      
      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Documents subcollection
      match /documents/{docId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Activities subcollection (includes daily updates with type='daily_update')
      match /activities/{activityId} {
        allow read: if isStaffUser();
        allow create: if isStaffUser();
        allow update: if isStaffUser();
        allow delete: if isAdmin();
      }
      
      // Expenses subcollection (financial tracking)
      match /expenses/{expenseId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
        
        // Budget document and nested transactions
        match /budget/transactions/{transactionId} {
          allow read: if isStaffUser();
          allow write: if isStaffUser();
        }
      }
      
      // Vendor Bills subcollection
      match /vendorBills/{billId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Materials subcollection (material requests)
      match /materials/{materialId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // BOQ (Bill of Quantities) subcollection
      match /boq/{boqId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Quotations subcollection
      match /quotations/{quotationId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Payments subcollection
      match /payments/{paymentId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
      
      // Execution-related subcollections
      match /execution/{docId} {
        allow read: if isStaffUser();
        allow write: if isStaffUser();
      }
    }
    
    // ========================================
    // GLOBAL COLLECTIONS
    // ========================================
    
    // Catalog (global, read-only for most users)
    match /catalog/{itemId} {
      allow read: if isStaffUser();
      allow write: if isAdmin();
    }
    
    // Project Enquiries (from landing page)
    match /projectEnquiries/{enquiryId} {
      allow read: if isStaffUser();
      allow create: if true; // Allow public creation from landing page
      allow update: if isStaffUser();
      allow delete: if isAdmin();
    }
    
    // Chat Channels
    match /chat_channels/{channelId} {
      allow read, write: if isStaffUser();
    }
    
    // Chat Messages
    match /chat_messages/{messageId} {
      allow read: if isStaffUser();
      allow create: if isStaffUser();
    }
    
    // Time Entries
    match /timeEntries/{entryId} {
      allow read: if isStaffUser();
      allow write: if isStaffUser();
    }
    
    // Calendar Tasks
    match /calendarTasks/{taskId} {
      allow read: if isStaffUser();
      allow write: if isStaffUser();
    }
    
    // Root-level Notifications collection (global)
    match /notifications/{notificationId} {
      allow read: if isStaffUser();
      allow write: if isStaffUser();
    }
    
    // Approvals collection (root level - for workflow approvals)
    match /approvals/{approvalId} {
      allow read: if isStaffUser();
      allow write: if isStaffUser();
    }
    
    // System collection (admin only)
    match /system/{document=**} {
      allow read: if isStaffUser();
      allow write: if isAdmin();
    }
    
    // ========================================
    // LEGACY COLLECTIONS (DEPRECATED)
    // Allow read for backward compatibility, prevent new writes
    // ========================================
    
    match /leads/{leadId} {
      allow read: if isStaffUser();
      allow write: if false; // Prevent new writes
    }
    
    match /projects/{projectId} {
      allow read: if isStaffUser();
      allow write: if false; // Prevent new writes
    }
    
    match /myDayTasks/{taskId} {
      allow read: if isStaffUser();
      allow write: if false; // Prevent new writes
    }
    
    match /approvalRequests/{requestId} {
      allow read: if isStaffUser();
      allow write: if false; // Prevent new writes
    }
  }
}
