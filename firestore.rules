rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN');
    }

    // ========================================
    // B2I CLIENTS
    // ========================================
    match /b2iClients/{b2iId} {
      // Super Admin: all access
      // B2I Parent (staff or client login): read own B2I doc
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.role == 'Super Admin' ||
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.b2iId == b2iId ||
        get(/databases/$(database)/documents/clients/$(request.auth.uid)).data.b2iId == b2iId
      );
      allow write: if isAuthenticated() &&
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.role == 'Super Admin';
    }

    // ========================================
    // CLIENTS (client portal users)
    // ========================================
    match /clients/{clientId} {
      // Clients can read/write their own doc
      allow read, write: if request.auth != null && request.auth.uid == clientId;
      // Staff can read all client docs
      allow read: if isAuthenticated();
    }

    // ========================================
    // ORGANIZATIONS
    // ========================================
    match /organizations/{orgId} {
      // Org users + B2I clients whose b2iId matches the org's b2iParentId
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() &&
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.role != 'B2I Client';
    }

    // ========================================
    // VENDORS
    // ========================================
    match /vendors/{vendorId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // ========================================
    // ERROR REPORTS
    // ========================================
    match /errorReports/{reportId} {
      allow read, write: if isAuthenticated();
    }

    // ========================================
    // CASES (Central Source of Truth)
    // ========================================
    match /cases/{caseId} {
       // Helper: Check if user is the assigned client (via email matches)
       function isCaseClient() {
         return request.auth.token.email == resource.data.clientEmail;
       }
       
       // Staff: Read/Write all (if they have a staff profile)
       allow read, write: if isAuthenticated() && 
         exists(/databases/$(database)/documents/staffUsers/$(request.auth.uid));
         
       // Client: Read own case
       allow read: if isAuthenticated() && isCaseClient();
       
       // Client: Restricted Update (Chat, Approvals & Lead Journey Reviews only)
       // They cannot delete or create cases, only update specific fields
       allow update: if isAuthenticated() && isCaseClient() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['chat', 'approvals', 'leadJourney', 'updatedAt']);
    }

    // ========================================
    // STAFF USERS (staff login: Auth â†’ staffUsers/{uid})
    // ========================================
    match /staffUsers/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if isAuthenticated();
    }

    // BASELINE SECURITY: Require authentication for everything
    match /{document=**} {
      allow read: if isAuthenticated();
      // Block writes for B2I clients (read-only); allow all other authenticated users
      allow write: if isAuthenticated() &&
        get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data.role != 'B2I Client';
    }
    
    // Specific collection rules can be added here to override or refine
    // e.g., match /organizations/{orgId} { allow write: if isAdmin(); }
  }
}
